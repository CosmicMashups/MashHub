import{r as m,j as e}from"./vendor-react-BqYHFrkR.js";import{a as N,c as w,r as I,u as $,A as L}from"./index-DrdfCScI.js";import{R as M,s as z,M as R,X as A,W as D,Z as F,_ as T,N as P,$ as q,L as B,c as G,P as O,T as H}from"./vendor-lucide-Bb8j8FOq.js";import{S as K,a as W}from"./Sheet-DSnqxl5f.js";import"./vendor-dexie-CKmTJlxL.js";import"./vendor-exceljs-Et7_ggJF.js";import"./vendor-dnd-dosGBBqk.js";import"./vendor-fuse-Dw8P0qyA.js";import"./vendor-motion-DuQQDTmZ.js";function _(r){const[l,t]=m.useState([]),[s,o]=m.useState(!1),[n,c]=m.useState(null),u=m.useCallback(async()=>{if(!r){t([]);return}try{o(!0),c(null);const g=(await N.getBySongId(r)).sort((d,x)=>d.sectionOrder-x.sectionOrder);t(g)}catch(a){c(a instanceof Error?a.message:"Failed to load sections"),console.error("Error loading sections:",a),t([])}finally{o(!1)}},[r]);return m.useEffect(()=>{let a=!1;return(async()=>{if(!r){a||(t([]),o(!1),c(null));return}try{o(!0),c(null);const d=await N.getBySongId(r);if(!a){const x=d.sort((i,f)=>i.sectionOrder-f.sectionOrder);t(x)}}catch(d){a||(c(d instanceof Error?d.message:"Failed to load sections"),console.error("Error loading sections:",d),t([]))}finally{a||o(!1)}})(),()=>{a=!0}},[r]),{sections:l,loading:s,error:n,reload:u}}function U({songId:r,className:l=""}){const{sections:t,loading:s,error:o}=_(r);return s?e.jsxs("div",{className:`flex items-center justify-center py-8 ${l}`,children:[e.jsx(M,{className:"animate-spin text-music-electric",size:24}),e.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading sections..."})]}):o?e.jsxs("div",{className:`flex items-center justify-center py-8 ${l}`,children:[e.jsx(z,{className:"text-red-500",size:24}),e.jsx("span",{className:"ml-3 text-red-600 dark:text-red-400",children:o})]}):t.length===0?e.jsxs("div",{className:`text-center py-8 ${l}`,children:[e.jsx(R,{className:"mx-auto text-gray-400",size:32}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:"No sections defined for this song"})]}):e.jsx("div",{className:`overflow-x-auto ${l}`,children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",role:"table","aria-label":"Song structure",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Order"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Part"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"BPM"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Key"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700",children:t.map(n=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",role:"row","aria-label":`Section ${n.sectionOrder}: ${n.part}, ${n.bpm} BPM, ${n.key}`,children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white",children:n.sectionOrder}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300",children:e.jsx("span",{className:"px-2 py-1 bg-music-cosmic/10 text-music-cosmic rounded-md text-sm font-medium",children:n.part})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:e.jsx("span",{className:"px-3 py-1 bg-music-wave/10 text-music-wave rounded-full text-sm font-bold font-mono",children:n.bpm})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300",children:e.jsx("span",{className:"px-3 py-1 bg-music-cosmic/10 text-music-cosmic rounded-full text-sm font-medium",children:n.key})})]},n.sectionId))})]})})}function X(r,l){const[t,s]=m.useState(null),[o,n]=m.useState(!1),c=m.useRef(null);return m.useEffect(()=>{if(!l||!r){s(null),n(!1),c.current&&(c.current.abort(),c.current=null);return}const u=w.get(r.id);if(u!==void 0){s(u),n(!1);return}n(!0),s(null);const a=new AbortController;return c.current=a,(async()=>{try{const d=await I(r);if(a.signal.aborted)return;w.set(r.id,d),s(d),n(!1)}catch(d){a.signal.aborted||(console.error("Error fetching cover image:",d),w.set(r.id,null),s(null),n(!1))}finally{c.current===a&&(c.current=null)}})(),()=>{c.current&&(c.current.abort(),c.current=null)}},[r,l]),{coverImageUrl:t,coverLoading:o}}const p=["#6366f1","#8b5cf6","#a855f7"];async function Y(r,l=3,t){if(!r)return p;try{if(t?.aborted)return p;const s=new Image;if(s.crossOrigin="anonymous",await new Promise((c,u)=>{s.onload=()=>c(s),s.onerror=()=>u(new Error("Failed to load image")),setTimeout(()=>u(new Error("Image load timeout")),5e3),s.src=r}),t?.aborted)return p;const n=Z(s,l,t);return n.length>0?n:p}catch(s){return console.warn("Failed to extract colors from image:",s),p}}function Z(r,l,t){try{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o)return p;const n=150,c=Math.min(n/r.width,n/r.height,1);s.width=r.width*c,s.height=r.height*c,o.drawImage(r,0,0,s.width,s.height);const a=o.getImageData(0,0,s.width,s.height).data,g=new Map,d=4;for(let i=0;i<a.length;i+=d*4){if(t?.aborted)return p;const f=a[i],y=a[i+1],b=a[i+2];if(a[i+3]<128)continue;const h=Math.floor(f/32)*32,S=Math.floor(y/32)*32,E=Math.floor(b/32)*32,k=`${h},${S},${E}`;g.set(k,(g.get(k)||0)+1)}const x=Array.from(g.entries()).sort((i,f)=>f[1]-i[1]).slice(0,l).map(([i])=>{const[f,y,b]=i.split(",").map(Number);return J(f,y,b)});for(;x.length<l;)x.push(x[x.length-1]||p[0]);return x}catch(s){return console.warn("Error extracting colors from canvas:",s),p}}function J(r,l,t){return"#"+[r,l,t].map(s=>{const o=s.toString(16);return o.length===1?"0"+o:o}).join("")}function Q(r,l=!1,t=.3){const n=l?"#1e293b":"#ffffff",c=f=>{const y=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(f);return y?{r:parseInt(y[1],16),g:parseInt(y[2],16),b:parseInt(y[3],16)}:null},u=(f,y,b)=>"#"+[f,y,b].map(j=>{const h=j.toString(16);return h.length===1?"0"+h:h}).join(""),a=c(r),g=c(n);if(!a||!g)return r;const d=Math.round(a.r*(1-t)+g.r*t),x=Math.round(a.g*(1-t)+g.g*t),i=Math.round(a.b*(1-t)+g.b*t);return u(d,x,i)}function v(r,l=!1){if(r.length===0)return`linear-gradient(135deg, ${p[0]}, ${p[1]})`;const t=r.map(o=>Q(o,l,.25));return t.length===1?`linear-gradient(135deg, ${t[0]}, ${t[0]})`:`linear-gradient(135deg, ${t.map((o,n)=>{const c=n/(t.length-1)*100;return`${o} ${c}%`}).join(", ")})`}const C=new Map;function V(r,l=!0){const[t,s]=m.useState(""),[o,n]=m.useState(p),[c,u]=m.useState(!1),[a,g]=m.useState(()=>document.documentElement.classList.contains("dark")),d=m.useRef(null),x=m.useRef(null),i=m.useRef(null);return m.useEffect(()=>{const f=new MutationObserver(()=>{g(document.documentElement.classList.contains("dark"))});return f.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>f.disconnect()},[]),m.useEffect(()=>{if(!l||!r){if(x.current!==null){const h=window;typeof h.cancelIdleCallback=="function"&&h.cancelIdleCallback(x.current),x.current=null}i.current!==null&&(clearTimeout(i.current),i.current=null),d.current&&(d.current.abort(),d.current=null),s(""),n(p),u(!1);return}const f=C.get(r);if(f){n(f),s(v(f,a)),u(!1);return}u(!0);const y=new AbortController;d.current=y;const b=async()=>{try{const h=await Y(r,3,y.signal);if(y.signal.aborted)return;C.set(r,h),n(h),s(v(h,a)),u(!1)}catch(h){y.signal.aborted||(console.warn("Failed to extract image colors:",h),n(p),s(v(p,a)),u(!1))}finally{d.current===y&&(d.current=null)}},j=window;return typeof j.requestIdleCallback=="function"?x.current=j.requestIdleCallback(()=>{x.current=null,b()},{timeout:1e3}):i.current=window.setTimeout(()=>{i.current=null,b()},0),()=>{if(x.current!==null){const h=window;typeof h.cancelIdleCallback=="function"&&h.cancelIdleCallback(x.current),x.current=null}i.current!==null&&(clearTimeout(i.current),i.current=null),d.current&&(d.current.abort(),d.current=null)}},[r,l,a]),{gradient:t,colors:o,loading:c}}function oe({isOpen:r,onClose:l,song:t,onEditSong:s,onAddToProject:o,onDeleteSong:n}){const{coverImageUrl:c}=X(r&&t?t:null,r),{gradient:u}=V(c,r&&!!c),a=m.useRef(null);m.useEffect(()=>{if(!r)return;const i=f=>{f.key==="Escape"&&l()};return document.addEventListener("keydown",i),()=>document.removeEventListener("keydown",i)},[r,l]),m.useEffect(()=>{r&&a.current&&a.current.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')?.focus()},[r]);const g=$();if(!r||!t)return null;const d=i=>{window.confirm("Are you sure you want to delete this song?")&&(n?.(i),l())},x=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 md:px-6 md:py-3 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{id:"song-details-title",className:"text-base md:text-lg font-semibold text-gray-900 dark:text-white",children:"Song Details"}),e.jsx("button",{onClick:l,className:"p-1.5 min-w-[36px] min-h-[36px] md:min-w-[44px] md:min-h-[44px] flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-md transition-colors","aria-label":"Close song details",children:e.jsx(A,{size:18,className:"md:w-5 md:h-5"})})]}),e.jsx("div",{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("div",{className:"w-full md:w-64 space-y-4",children:[e.jsx("div",{className:"w-full",children:e.jsx(L,{imageUrl:c??void 0,alt:`${t.title} by ${t.artist}`,size:"large",lazy:!1,className:"w-full h-full",aspectRatio:t.type?.toLowerCase()==="anime"?"portrait":"square"})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(D,{size:16,className:"text-music-sonic"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Origin"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white break-words",children:t.origin})]})]})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:t.title}),e.jsxs("p",{className:"text-lg text-gray-600 dark:text-gray-400 mb-1",children:["by ",t.artist]}),t.part&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:t.part})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center",children:[e.jsx(F,{size:18,className:"mr-2 text-music-pulse"}),"Metadata"]}),e.jsxs("div",{className:"flex justify-between items-start max-w-2xl",children:[e.jsxs("div",{className:"flex items-center space-x-3 flex-1 justify-center",children:[e.jsx(T,{size:16,className:"text-music-beat"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Type"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:t.type})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 flex-1 justify-center",children:[e.jsx(P,{size:16,className:"text-music-wave"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Season"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:t.season})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 flex-1 justify-center",children:[e.jsx(q,{size:16,className:"text-music-pulse"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Year"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:t.year})]})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center mb-4",children:[e.jsx(B,{size:18,className:"mr-2 text-music-electric"}),"Song Structure"]}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4",children:e.jsx(U,{songId:t.id})})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-2 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("button",{onClick:()=>o?.(t),className:"flex-shrink-0 px-4 py-2.5 min-h-[44px] bg-music-electric text-white rounded-lg hover:bg-music-electric/90 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(G,{className:"h-4 w-4"}),"Add to Project"]}),e.jsxs("button",{onClick:()=>s?.(t),className:"flex-shrink-0 px-4 py-2.5 min-h-[44px] bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(O,{className:"h-4 w-4"}),"Edit Song"]}),e.jsxs("button",{onClick:()=>d(t.id),className:"flex-shrink-0 px-4 py-2.5 min-h-[44px] bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(H,{className:"h-4 w-4"}),"Delete Song"]}),e.jsx("button",{onClick:l,className:"flex-shrink-0 px-4 py-2.5 min-h-[44px] bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors text-sm",children:"Close"})]})]})]})})]});return g?e.jsx(K,{open:r,onOpenChange:l,children:e.jsx(W,{side:"bottom",className:"h-[85vh] p-0 flex flex-col",showDragHandle:!0,children:e.jsx("div",{className:"flex-1 overflow-y-auto bg-white dark:bg-gray-800",children:e.jsx(x,{})})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:l,role:"dialog","aria-modal":"true","aria-labelledby":"song-details-title",children:e.jsxs("div",{ref:a,className:`rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col relative overflow-hidden ${u?"":"bg-white dark:bg-gray-800"}`,style:u?{background:u}:void 0,onClick:i=>i.stopPropagation(),role:"document",children:[u&&e.jsx("div",{className:"absolute inset-0 bg-white/40 dark:bg-gray-800/50 pointer-events-none"}),e.jsx("div",{className:"relative z-10 overflow-y-auto flex-1 min-h-0",children:e.jsx(x,{})})]})})}export{oe as SongDetailsModal};
