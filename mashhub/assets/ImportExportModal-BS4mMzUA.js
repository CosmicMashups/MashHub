import{r as E,j as e}from"./vendor-react-BqYHFrkR.js";import{E as F}from"./vendor-exceljs-Et7_ggJF.js";import{p as $,b as A,u as M}from"./index-DrdfCScI.js";import{S as B,a as V}from"./Sheet-DSnqxl5f.js";import{X as Y,n as P,z as O,U as D}from"./vendor-lucide-Bb8j8FOq.js";import"./vendor-dexie-CKmTJlxL.js";import"./vendor-dnd-dosGBBqk.js";import"./vendor-fuse-Dw8P0qyA.js";import"./vendor-motion-DuQQDTmZ.js";class I{static async importFromCSV(i){return new Promise((o,a)=>{const s=new FileReader;s.onload=r=>{try{const n=r.target?.result,t=n.split(`
`)[0].toUpperCase();if(t.includes("SECTION_ID")||t.includes("SONG_ID"))$(n),a(new Error("Please import songs.csv first, then song_sections.csv"));else if(t.includes("ID")&&!t.includes("SECTION"))if(t.includes("BPM")&&t.includes("KEY")&&t.includes("PART")){const c=this.parseCSV(n);o(c)}else{const c=A(n);o(c)}else{const c=this.parseCSV(n);o(c)}}catch(n){a(n)}},s.onerror=()=>a(new Error("Failed to read file")),s.readAsText(i)})}static async importFromTwoCSVFiles(i,o){return new Promise((a,s)=>{let r="",n="",t=!1,c=!1;const p=[],d=()=>{if(t&&c)try{const x=A(r),y=$(n),w=new Set(x.map(l=>l.id)),S=y.filter(l=>!w.has(l.songId));S.length>0&&p.push(`Warning: ${S.length} sections reference non-existent songs`);const j=y.filter(l=>w.has(l.songId));a({songs:x,sections:j,errors:p})}catch(x){s(x)}},f=new FileReader;f.onload=x=>{r=x.target?.result,t=!0,d()},f.onerror=()=>{p.push("Failed to read songs.csv"),t=!0,d()},f.readAsText(i);const h=new FileReader;h.onload=x=>{n=x.target?.result,c=!0,d()},h.onerror=()=>{p.push("Failed to read song_sections.csv"),c=!0,d()},h.readAsText(o)})}static async importFromXLSX(i){return new Promise((o,a)=>{const s=new FileReader;s.onload=async r=>{try{const n=r.target?.result,t=new F.Workbook;await t.xlsx.load(n);const c=t.worksheets[0],p=this.parseWorksheet(c);o(p)}catch(n){a(n)}},s.onerror=()=>a(new Error("Failed to read file")),s.readAsArrayBuffer(i)})}static parseCSV(i){const o=i.split(`
`).filter(r=>r.trim()),a=o[0].split(",").map(r=>r.trim()),s=[];for(let r=1;r<o.length;r++){const n=this.parseCSVLine(o[r]);if(n.length!==0)try{const t=this.createSongFromRow(a,n,r);t&&s.push(t)}catch(t){console.warn(`Skipping row ${r+1}: ${t}`)}}return s}static parseWorksheet(i){const o=[],a=[];return i.getRow(1).eachCell((s,r)=>{a[r-1]=s.text.trim()}),i.eachRow((s,r)=>{if(r===1)return;const n=[];s.eachCell((t,c)=>{n[c-1]=t.text.trim()});try{const t=this.createSongFromRow(a,n,r);t&&o.push(t)}catch(t){console.warn(`Skipping row ${r}: ${t}`)}}),o}static createSongFromRow(i,o,a){const s=m=>i.findIndex(N=>N.toLowerCase().includes(m.toLowerCase())),r=s("id"),n=s("title"),t=s("bpm"),c=s("key"),p=s("part"),d=s("artist"),f=s("type"),h=s("origin"),x=s("year"),y=s("season");if(n===-1||!o[n]?.trim())throw new Error("Missing title");if(d===-1||!o[d]?.trim())throw new Error("Missing artist");const w=t!==-1?o[t]:"",S=w?w.split("|").map(m=>parseFloat(m.trim())).filter(m=>!isNaN(m)):[0],j=c!==-1?o[c]:"",l=j?j.split("|").map(m=>m.trim()).filter(m=>m):["C Major"];return{id:r!==-1&&o[r]?.trim()?o[r].trim().padStart(5,"0"):(a+1e3).toString().padStart(5,"0"),title:o[n].trim(),artist:o[d].trim(),part:p!==-1&&o[p]?.trim()||"",type:f!==-1&&o[f]?.trim()||"",origin:h!==-1&&o[h]?.trim()||"",year:x!==-1?parseInt(o[x])||new Date().getFullYear():new Date().getFullYear(),season:y!==-1&&o[y]?.trim()||"Spring",bpms:S,keys:l,primaryBpm:S[0]||0,primaryKey:l[0]||"C Major"}}static parseCSVLine(i){const o=[];let a="",s=!1;for(let r=0;r<i.length;r++){const n=i[r];n==='"'?s=!s:n===","&&!s?(o.push(a.trim()),a=""):a+=n}return o.push(a.trim()),o}static async exportToCSV(i){const a=[["ID","TITLE","BPM","KEY","PART","ARTIST","TYPE","ORIGIN","YEAR","SEASON"].join(","),...i.map(s=>[s.id,`"${s.title}"`,s.bpms.join("|"),s.keys.join("|"),"",`"${s.artist}"`,`"${s.type}"`,`"${s.origin}"`,s.year,`"${s.season}"`].join(","))].join(`
`);return new Blob([a],{type:"text/csv;charset=utf-8;"})}static async exportToTwoCSVFiles(i,o){const s=[["ID","TITLE","ARTIST","TYPE","ORIGIN","SEASON","YEAR","NOTES"].join(","),...i.map(t=>[t.id,`"${t.title.replace(/"/g,'""')}"`,`"${t.artist.replace(/"/g,'""')}"`,`"${t.type.replace(/"/g,'""')}"`,`"${t.origin.replace(/"/g,'""')}"`,`"${t.season.replace(/"/g,'""')}"`,t.year,`"${(t.notes||"").replace(/"/g,'""')}"`].join(","))].join(`
`),n=[["SECTION_ID","SONG_ID","PART","BPM","KEY","SECTION_ORDER"].join(","),...o.map(t=>[t.sectionId,t.songId,`"${t.part.replace(/"/g,'""')}"`,t.bpm,`"${t.key.replace(/"/g,'""')}"`,t.sectionOrder].join(","))].join(`
`);return{songsBlob:new Blob([s],{type:"text/csv;charset=utf-8;"}),sectionsBlob:new Blob([n],{type:"text/csv;charset=utf-8;"})}}static async exportToCombinedCSV(i,o){const a=["ID","TITLE","ARTIST","TYPE","ORIGIN","SEASON","YEAR","NOTES","PART","BPM","KEY","SECTION_ORDER"],s=new Map(i.map(n=>[n.id,n])),r=[a.join(","),...o.map(n=>{const t=s.get(n.songId);return t?[t.id,`"${t.title.replace(/"/g,'""')}"`,`"${t.artist.replace(/"/g,'""')}"`,`"${t.type.replace(/"/g,'""')}"`,`"${t.origin.replace(/"/g,'""')}"`,`"${t.season.replace(/"/g,'""')}"`,t.year,`"${(t.notes||"").replace(/"/g,'""')}"`,`"${n.part.replace(/"/g,'""')}"`,n.bpm,`"${n.key.replace(/"/g,'""')}"`,n.sectionOrder].join(","):null}).filter(n=>n!==null)].join(`
`);return new Blob([r],{type:"text/csv;charset=utf-8;"})}static async exportToXLSX(i){const o=new F.Workbook,a=o.addWorksheet("Songs");a.columns=[{header:"ID",key:"id",width:10},{header:"TITLE",key:"title",width:30},{header:"BPM",key:"bpms",width:15},{header:"KEY",key:"keys",width:20},{header:"PART",key:"part",width:15},{header:"ARTIST",key:"artist",width:25},{header:"TYPE",key:"type",width:15},{header:"ORIGIN",key:"origin",width:15},{header:"YEAR",key:"year",width:10},{header:"SEASON",key:"season",width:10}],i.forEach(r=>{a.addRow({id:r.id,title:r.title,bpms:r.bpms.join("|"),keys:r.keys.join("|"),part:r.part,artist:r.artist,type:r.type,origin:r.origin,year:r.year,season:r.season})}),a.getRow(1).font={bold:!0},a.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const s=await o.xlsx.writeBuffer();return new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}static downloadFile(i,o){const a=window.URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a)}}function Q({isOpen:T,onClose:i,onImport:o,songs:a}){const[s,r]=E.useState(!1),[n,t]=E.useState("csv"),[c,p]=E.useState(null),[d,f]=E.useState(null),h=E.useRef(null),x=M();if(!T)return null;const y=async l=>{const g=l.target.files?.[0];if(g){r(!0),p(null);try{let u;if(g.name.toLowerCase().endsWith(".csv"))u=await I.importFromCSV(g);else if(g.name.toLowerCase().endsWith(".xlsx")||g.name.toLowerCase().endsWith(".xls"))u=await I.importFromXLSX(g);else throw new Error("Unsupported file format. Please select a CSV or XLSX file.");if(u.length===0)throw new Error("No valid songs found in the file.");const m=100,N=Math.ceil(u.length/m);let k=0;const R=[];f({current:0,total:u.length});for(let b=0;b<N;b++){const v=u.slice(b*m,(b+1)*m);try{await o(v),k+=v.length,f({current:(b+1)*m,total:u.length})}catch(C){const L=C instanceof Error?C.message:"Batch import failed";R.push(`Batch ${b+1}: ${L}`)}b<N-1&&await new Promise(C=>setTimeout(C,0))}f(null),p({success:k,errors:R}),h.current&&(h.current.value="")}catch(u){p({success:0,errors:[u instanceof Error?u.message:"Import failed"]})}finally{r(!1)}}},w=async()=>{try{const l=await I.exportToCSV(a);I.downloadFile(l,`mashup-songs-${new Date().toISOString().split("T")[0]}.csv`)}catch(l){console.error("Export failed:",l),alert("Export failed. Please try again.")}},S=async()=>{try{const l=await I.exportToXLSX(a);I.downloadFile(l,`mashup-songs-${new Date().toISOString().split("T")[0]}.xlsx`)}catch(l){console.error("Export failed:",l),alert("Export failed. Please try again.")}},j=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-4 md:p-6 border-b",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-gray-900",children:"Import / Export Songs"}),e.jsx("button",{onClick:i,className:"p-2 min-w-[44px] min-h-[44px] flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-md transition-colors","aria-label":"Close",children:e.jsx(Y,{size:20,className:"md:w-6 md:h-6"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Import Songs"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select File Format"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:space-x-4",children:[e.jsxs("label",{className:"flex items-center min-h-[44px] cursor-pointer",children:[e.jsx("input",{type:"radio",value:"csv",checked:n==="csv",onChange:l=>t(l.target.value),className:"mr-2 w-5 h-5"}),e.jsx(P,{size:16,className:"mr-1"}),"CSV"]}),e.jsxs("label",{className:"flex items-center min-h-[44px] cursor-pointer",children:[e.jsx("input",{type:"radio",value:"xlsx",checked:n==="xlsx",onChange:l=>t(l.target.value),className:"mr-2 w-5 h-5"}),e.jsx(O,{size:16,className:"mr-1"}),"Excel (XLSX)"]})]})]}),e.jsxs("div",{children:[e.jsx("input",{ref:h,type:"file",accept:n==="csv"?".csv":".xlsx,.xls",onChange:y,className:"hidden"}),e.jsxs("button",{onClick:()=>h.current?.click(),disabled:s,className:"btn-primary flex items-center justify-center space-x-2 min-h-[44px] w-full sm:w-auto",children:[e.jsx(D,{size:16}),e.jsx("span",{children:s?"Importing...":"Choose File"})]})]}),d&&e.jsxs("div",{className:"p-3 rounded-md bg-blue-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:["Importing... ",d.current," / ",d.total]}),e.jsxs("span",{className:"text-sm text-blue-700",children:[Math.round(d.current/d.total*100),"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${d.current/d.total*100}%`}})})]}),c&&!d&&e.jsxs("div",{className:`p-3 rounded-md ${c.success>0?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:[e.jsx("p",{className:"font-medium",children:c.success>0?`Successfully imported ${c.success} songs`:"Import failed"}),c.errors.length>0&&e.jsx("ul",{className:"mt-2 text-sm list-disc list-inside",children:c.errors.map((l,g)=>e.jsx("li",{children:l},g))})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Export Songs"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Export all ",a.length," songs to a file"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:space-x-3",children:[e.jsxs("button",{onClick:w,className:"btn-secondary flex items-center justify-center space-x-2 min-h-[44px] w-full sm:w-auto",children:[e.jsx(P,{size:16}),e.jsx("span",{children:"Export CSV"})]}),e.jsxs("button",{onClick:S,className:"btn-secondary flex items-center justify-center space-x-2 min-h-[44px] w-full sm:w-auto",children:[e.jsx(O,{size:16}),e.jsx("span",{children:"Export Excel"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:"Expected CSV Format"}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:"Your CSV should have these columns (case-insensitive):"}),e.jsx("code",{className:"text-xs bg-white p-2 rounded border block",children:"ID,TITLE,BPM,KEY,PART,ARTIST,TYPE,ORIGIN,YEAR,SEASON"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:'Note: Multiple BPMs/Keys can be separated with | (e.g., "120|240" or "C Major|A Minor")'})]})]}),e.jsx("div",{className:"flex justify-end p-4 md:p-6 border-t bg-gray-50",children:e.jsx("button",{onClick:i,className:"btn-secondary w-full sm:w-auto min-h-[44px]",children:"Close"})})]});return x?e.jsx(B,{open:T,onOpenChange:i,children:e.jsx(V,{side:"bottom",className:"h-[85vh] p-0 flex flex-col",showDragHandle:!0,children:e.jsx("div",{className:"flex-1 overflow-y-auto bg-white",children:e.jsx(j,{})})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:e.jsx(j,{})})})}export{Q as ImportExportModal};
