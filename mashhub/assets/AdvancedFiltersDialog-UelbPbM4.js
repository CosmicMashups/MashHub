import{r as c,j as e}from"./vendor-react-BqYHFrkR.js";import{i as F,h as J,B as _,K as X,u as S,a as W,M as Y}from"./index-DrdfCScI.js";import{h as Z,x as ee,X as z,y as re,M as ae,F as se,S as te,c as de}from"./vendor-lucide-Bb8j8FOq.js";import{S as le,a as ne}from"./Sheet-DSnqxl5f.js";import"./vendor-dexie-CKmTJlxL.js";import"./vendor-exceljs-Et7_ggJF.js";import"./vendor-dnd-dosGBBqk.js";import"./vendor-fuse-Dw8P0qyA.js";import"./vendor-motion-DuQQDTmZ.js";const ce=["Verse","Chorus","Bridge","Intro","Outro","Pre-Chorus"];function oe({block:x,index:h,availableParts:g,onChange:a,onDelete:l,isCollapsed:j=!1,onToggleCollapse:v}){const[m,M]=c.useState(x.part||""),[i,k]=c.useState(x.bpm||{mode:null}),[t,f]=c.useState(Array.isArray(x.key)?x.key:[]),w=[...new Set([...ce,...g])].sort(),u=F({part:m,bpm:i,key:t}),p=m||J(i)||t&&t.length>0,C=n=>{M(n),a({part:n,bpm:i,key:t})},P=n=>{k(n),a({part:m,bpm:n,key:t})},A=n=>{f(n),a({part:m,bpm:i,key:n})},B=()=>{const n={mode:null};k(n),a({part:m,bpm:n,key:t})},K=()=>{f([]),a({part:m,bpm:i,key:[]})};return e.jsxs("div",{className:`border rounded-lg p-4 ${u?"border-primary-300 bg-primary-50/50 dark:border-primary-700 dark:bg-primary-900/10":p?"border-yellow-300 bg-yellow-50/50 dark:border-yellow-700 dark:bg-yellow-900/10":"border-gray-300 dark:border-gray-600"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:["Filter Block ",h+1]}),!u&&p&&e.jsx("span",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:"Incomplete"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[v&&e.jsx("button",{type:"button",onClick:v,className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300","aria-label":j?"Expand":"Collapse",children:j?e.jsx(Z,{size:16}):e.jsx(ee,{size:16})}),e.jsx("button",{type:"button",onClick:l,className:"p-1 text-gray-400 hover:text-red-600 dark:hover:text-red-400","aria-label":"Delete filter block",children:e.jsx(z,{size:16})})]})]}),!j&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:["PART ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:m,onChange:n=>C(n.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",children:[e.jsx("option",{value:"",children:"Select PART..."}),w.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"BPM Filter (Optional)"}),e.jsx(_,{value:i,onChange:P,onClear:B})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Key Filter (Optional)"}),e.jsx(X,{value:t,onChange:A,onClear:K})]}),!u&&p&&e.jsx("div",{className:"text-xs text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded",children:"Please select a PART and at least one harmonic constraint (BPM or Key)."})]})]})}function je({isOpen:x,onClose:h,songs:g,filterState:a,onFilterStateChange:l,onApplyFilters:j,onSongClick:v}){const[m,M]=c.useState([]),[i,k]=c.useState(new Set),[t,f]=c.useState(null),[w,u]=c.useState([]),[p,C]=c.useState(!1),P=S();c.useEffect(()=>{x&&W.getUniqueParts().then(r=>{M(r)})},[x]);const A=c.useCallback(async()=>{if(!t||p)return;C(!0);const r=t.id;try{const s=await Y.getQuickMatches(g,t);t&&t.id===r&&u(s.slice(0,5))}catch(s){console.error("Quick match failed:",s)}finally{C(!1)}},[t,p,g]),B=()=>{const r=(a.advanced.partSpecific||[]).filter(F),s={...a,advanced:{...a.advanced,partSpecific:r}};l(s),j(s),h()},K=()=>{const r={...a,advanced:{type:"",origin:"",season:"",artist:"",text:"",partSpecific:[],partSpecificKey:null}};l(r),f(null),u([])},n=()=>{const r={part:void 0,bpm:{mode:null},key:[]},s={...a,advanced:{...a.advanced,partSpecific:[...a.advanced.partSpecific||[],r]}};l(s)},$=(r,s)=>{const o={...a,advanced:{...a.advanced,partSpecific:(a.advanced.partSpecific||[]).map((y,b)=>b===r?s:y)}};l(o)},E=r=>{const s={...a,advanced:{...a.advanced,partSpecific:(a.advanced.partSpecific||[]).filter((y,b)=>b!==r)}};l(s);const o=new Set(i);o.delete(r),k(o)},L=r=>{const s=new Set(i);s.has(r)?s.delete(r):s.add(r),k(s)},N=a.advanced.partSpecific||[],I=N.length>3,O=c.useCallback(r=>{l({...a,advanced:{...a.advanced,text:r}})},[a,l]),Q=c.useCallback(r=>{l({...a,advanced:{...a.advanced,type:r}})},[a,l]),G=c.useCallback(r=>{l({...a,advanced:{...a.advanced,origin:r}})},[a,l]),H=c.useCallback(r=>{l({...a,advanced:{...a.advanced,season:r}})},[a,l]),q=c.useCallback(r=>{l({...a,advanced:{...a.advanced,artist:r}})},[a,l]),T=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-4 md:p-6 border-b dark:border-gray-700",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100",children:"Advanced Filters & Matching"}),e.jsx("button",{onClick:h,className:"p-2 min-w-[44px] min-h-[44px] flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-md transition-colors","aria-label":"Close",children:e.jsx(z,{size:20,className:"md:w-6 md:h-6"})})]}),e.jsxs("div",{className:"p-6 space-y-8",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 flex items-center justify-center",children:[e.jsx(re,{size:20,className:"mr-2"}),"Quick Match"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select a song to find matches"}),e.jsxs("select",{value:t?.id||"",onChange:r=>{const s=g.find(o=>o.id===r.target.value)??null;f(s),u([])},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",children:[e.jsx("option",{value:"",children:"Choose a song..."}),g.map(r=>e.jsxs("option",{value:r.id,children:[r.title," - ",r.artist," (",r.primaryBpm||r.bpms?.[0]||"N/A"," BPM, ",r.primaryKey||r.keys?.[0]||"N/A",")"]},r.id))]})]}),t&&e.jsxs("div",{className:"bg-white dark:bg-gray-700 p-3 rounded border dark:border-gray-600",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100",children:"Selected Song:"}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:[t.title," - ",t.artist]}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:["BPM: ",t.bpms?.join(", ")||"N/A"," | Key: ",t.keys?.join(", ")||"N/A"]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs("button",{onClick:A,disabled:!t||p,className:"btn-primary flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ae,{size:16,className:p?"animate-pulse":""}),e.jsx("span",{children:p?"Finding Matches…":"Find Matches"})]})}),w.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 text-center",children:"Top Matches:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:w.map(r=>{const s=r.matchScore||0,o=d=>d>=.85?"text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800":d>=.65?"text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800":"text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600",y=d=>d>=.85?"text-green-700 dark:text-green-300":d>=.65?"text-amber-700 dark:text-amber-300":"text-gray-600 dark:text-gray-400",b=o(s),V=y(s),R=r.reasons?.map(d=>d.includes("BPM")?"BPM":d.includes("Key")||d.includes("key")?"Key":d.includes("Part")||d.includes("Section")?"Section":d.split(":")[0]||d).filter((d,D,U)=>U.indexOf(d)===D)||[];return e.jsx("div",{className:`bg-white dark:bg-gray-700 p-4 rounded-lg border-2 ${b} transition-shadow hover:shadow-md cursor-pointer`,onClick:()=>v?.(r),role:"button",tabIndex:0,onKeyDown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),v?.(r))},children:e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100 text-sm truncate",title:r.title,children:r.title}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate",title:r.artist,children:r.artist})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-200 dark:border-gray-600",children:[e.jsxs("span",{className:`text-xs font-semibold ${V}`,children:[Math.round(s*100),"%"]}),e.jsx("span",{className:`text-xs ${V}`,children:s>=.85?"High":s>=.65?"Medium":"Low"})]}),R.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 pt-2",children:R.slice(0,3).map((d,D)=>e.jsx("span",{className:`inline-block text-xs px-2 py-0.5 rounded ${b}`,children:d},D))})]})},r.id)})})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 flex items-center justify-center",children:[e.jsx(se,{size:20,className:"mr-2"}),"Advanced Filters"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Search Text"}),e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),e.jsx("input",{type:"text",value:a.advanced.text||"",onChange:r=>O(r.target.value),className:"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",placeholder:"Search by title, artist, or type..."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Type"}),e.jsxs("select",{value:a.advanced.type||"",onChange:r=>Q(r.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"Anime",children:"Anime"}),e.jsx("option",{value:"Game",children:"Game"}),e.jsx("option",{value:"J-Pop",children:"J-Pop"}),e.jsx("option",{value:"K-Pop",children:"K-Pop"}),e.jsx("option",{value:"Electronic",children:"Electronic"}),e.jsx("option",{value:"Rock",children:"Rock"}),e.jsx("option",{value:"Pop",children:"Pop"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Origin"}),e.jsx("input",{type:"text",value:a.advanced.origin||"",onChange:r=>G(r.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",placeholder:"Filter by origin..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Season"}),e.jsx("input",{type:"text",value:a.advanced.season||"",onChange:r=>H(r.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",placeholder:"Filter by season..."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Artist"}),e.jsx("input",{type:"text",value:a.advanced.artist||"",onChange:r=>q(r.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",placeholder:"Filter by artist..."})]})]})]}),e.jsxs("div",{className:"border-t dark:border-gray-700 pt-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 text-center",children:"Part-Specific Key Filter"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Section"}),e.jsxs("select",{value:a.advanced.partSpecificKey?.section||"",onChange:r=>l({...a,advanced:{...a.advanced,partSpecificKey:r.target.value?{section:r.target.value,key:a.advanced.partSpecificKey?.key||""}:null}}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",children:[e.jsx("option",{value:"",children:"Select Section"}),e.jsx("option",{value:"Intro",children:"Intro"}),e.jsx("option",{value:"Intro 1",children:"Intro 1"}),e.jsx("option",{value:"Intro 2",children:"Intro 2"}),e.jsx("option",{value:"Intro Drop",children:"Intro Drop"}),e.jsx("option",{value:"Intro Drop 1",children:"Intro Drop 1"}),e.jsx("option",{value:"Intro Drop 2",children:"Intro Drop 2"}),e.jsx("option",{value:"Verse",children:"Verse"}),e.jsx("option",{value:"Verse A",children:"Verse A"}),e.jsx("option",{value:"Verse B",children:"Verse B"}),e.jsx("option",{value:"Verse C",children:"Verse C"}),e.jsx("option",{value:"Verse 2",children:"Verse 2"}),e.jsx("option",{value:"Prechorus",children:"Prechorus"}),e.jsx("option",{value:"Prechorus A",children:"Prechorus A"}),e.jsx("option",{value:"Prechorus B",children:"Prechorus B"}),e.jsx("option",{value:"Prechorus C",children:"Prechorus C"}),e.jsx("option",{value:"Chorus",children:"Chorus"}),e.jsx("option",{value:"Chorus A",children:"Chorus A"}),e.jsx("option",{value:"Chorus B",children:"Chorus B"}),e.jsx("option",{value:"Chorus 2",children:"Chorus 2"}),e.jsx("option",{value:"Postchorus",children:"Postchorus"}),e.jsx("option",{value:"Bridge",children:"Bridge"}),e.jsx("option",{value:"Last Chorus",children:"Last Chorus"}),e.jsx("option",{value:"Last Postchorus",children:"Last Postchorus"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Key"}),e.jsxs("select",{value:a.advanced.partSpecificKey?.key||"",onChange:r=>l({...a,advanced:{...a.advanced,partSpecificKey:a.advanced.partSpecificKey?.section&&r.target.value?{section:a.advanced.partSpecificKey.section,key:r.target.value}:a.advanced.partSpecificKey?.section?{section:a.advanced.partSpecificKey.section,key:""}:null}}),disabled:!a.advanced.partSpecificKey?.section,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("option",{value:"",children:"Select Key"}),e.jsx("option",{value:"C Major",children:"C Major"}),e.jsx("option",{value:"C# Major",children:"C# Major"}),e.jsx("option",{value:"D Major",children:"D Major"}),e.jsx("option",{value:"D# Major",children:"D# Major"}),e.jsx("option",{value:"E Major",children:"E Major"}),e.jsx("option",{value:"F Major",children:"F Major"}),e.jsx("option",{value:"F# Major",children:"F# Major"}),e.jsx("option",{value:"G Major",children:"G Major"}),e.jsx("option",{value:"G# Major",children:"G# Major"}),e.jsx("option",{value:"A Major",children:"A Major"}),e.jsx("option",{value:"A# Major",children:"A# Major"}),e.jsx("option",{value:"B Major",children:"B Major"})]})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:()=>l({...a,advanced:{...a.advanced,partSpecificKey:null}}),disabled:!a.advanced.partSpecificKey,className:"w-full px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Clear"})})]})]}),e.jsxs("div",{className:"border-t dark:border-gray-700 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 flex-1 text-center",children:"Filter by Harmonic at Specific PART"}),e.jsxs("button",{type:"button",onClick:n,className:"flex items-center px-3 py-2 text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 border border-primary-300 dark:border-primary-700 rounded-md hover:bg-primary-50 dark:hover:bg-primary-900/20",children:[e.jsx(de,{size:16,className:"mr-2"}),"Add Part Filter"]})]}),N.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 italic",children:'No PART-specific filters added. Click "Add Part Filter" to filter songs by harmonic properties at specific sections.'}):e.jsx("div",{className:"space-y-4",children:N.map((r,s)=>e.jsx(oe,{block:r,index:s,availableParts:m,onChange:o=>$(s,o),onDelete:()=>E(s),isCollapsed:I&&s>=3&&i.has(s),onToggleCollapse:I&&s>=3?()=>L(s):void 0},s))}),N.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded border dark:border-gray-600",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Active PART Filters:"}),e.jsx("div",{className:"space-y-1",children:N.map((r,s)=>{if(!F(r))return null;const o=r.bpm?.mode==="target"?`${r.bpm.target} ±${r.bpm.tolerance}`:r.bpm?.mode==="range"?`${r.bpm.min}-${r.bpm.max}`:"",y=Array.isArray(r.key)&&r.key.length>0?r.key.length===1?r.key[0]:`${r.key.length} keys`:"";return e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:[e.jsx("span",{className:"font-medium",children:r.part}),o&&e.jsxs("span",{className:"ml-2",children:["BPM: ",o]}),y&&e.jsxs("span",{className:"ml-2",children:["Key: ",y]})]},s)})})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between gap-2 md:gap-0 p-4 md:p-6 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:[e.jsx("button",{onClick:K,className:"btn-secondary w-full md:w-auto min-h-[44px]",children:"Clear All"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-2 md:space-x-3 w-full md:w-auto",children:[e.jsx("button",{onClick:h,className:"btn-secondary w-full md:w-auto min-h-[44px]",children:"Cancel"}),e.jsx("button",{onClick:B,className:"btn-primary w-full md:w-auto min-h-[44px]",children:"Apply Filters"})]})]})]});return x?P?e.jsx(le,{open:x,onOpenChange:h,children:e.jsx(ne,{side:"bottom",className:"h-[90vh] p-0 flex flex-col",showDragHandle:!0,children:e.jsx("div",{className:"flex-1 overflow-y-auto",children:T()})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:T()})}):null}export{je as AdvancedFiltersDialog};
