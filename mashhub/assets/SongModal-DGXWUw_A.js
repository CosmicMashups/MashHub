const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DrdfCScI.js","assets/vendor-react-BqYHFrkR.js","assets/vendor-dexie-CKmTJlxL.js","assets/vendor-lucide-Bb8j8FOq.js","assets/vendor-exceljs-Et7_ggJF.js","assets/vendor-dnd-dosGBBqk.js","assets/vendor-fuse-Dw8P0qyA.js","assets/vendor-motion-DuQQDTmZ.js","assets/index-CqbBsc11.css"])))=>i.map(i=>d[i]);
import{s as R,a as C,_ as L,u as J,A as K}from"./index-DrdfCScI.js";import{r as c,j as e}from"./vendor-react-BqYHFrkR.js";import{p as T,u as O,v as Y,w as G,X as q,s as U,c as W,f as H,g as X,T as Q}from"./vendor-lucide-Bb8j8FOq.js";import{S as Z,a as ee}from"./Sheet-DSnqxl5f.js";import"./vendor-dexie-CKmTJlxL.js";import"./vendor-exceljs-Et7_ggJF.js";import"./vendor-dnd-dosGBBqk.js";import"./vendor-fuse-Dw8P0qyA.js";import"./vendor-motion-DuQQDTmZ.js";function re(m){const[p,y]=c.useState(null),[j,t]=c.useState(!1),[b,f]=c.useState(null),a=m?.id;return c.useEffect(()=>{if(!a){y(null);return}(async()=>{t(!0),f(null);try{const n=await R.getMapping(a);y(n||null)}catch(n){console.error("Error loading Spotify mapping:",n),f(n instanceof Error?n.message:"Failed to load Spotify data"),y(null)}finally{t(!1)}})()},[a]),{mapping:p,loading:j,error:b,refreshMapping:async()=>{if(m){t(!0),f(null);try{const o=await R.searchAndMap(m);y(o)}catch(o){console.error("Error refreshing Spotify mapping:",o),f(o instanceof Error?o.message:"Failed to refresh Spotify data")}finally{t(!1)}}}}}function te({previewUrl:m,spotifyUrl:p,className:y=""}){const[j,t]=c.useState(!1),[b,f]=c.useState(1),a=c.useRef(null);c.useEffect(()=>{const n=a.current;if(!n)return;n.volume=b;const l=()=>t(!1),S=()=>t(!0),v=()=>t(!1);return n.addEventListener("ended",l),n.addEventListener("play",S),n.addEventListener("pause",v),()=>{n.removeEventListener("ended",l),n.removeEventListener("play",S),n.removeEventListener("pause",v)}},[b]);const x=()=>{const n=a.current;n&&(j?n.pause():n.play().catch(l=>{console.error("Error playing preview:",l),t(!1)}))},o=n=>{const l=parseFloat(n.target.value);f(l),a.current&&(a.current.volume=l)};return!m&&!p?e.jsx("div",{className:`text-sm text-gray-500 dark:text-gray-400 ${y}`,children:"Preview not available"}):!m&&p?e.jsxs("div",{className:`flex items-center gap-2 ${y}`,children:[e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Preview not available"}),e.jsxs("a",{href:p,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-sm text-blue-600 dark:text-blue-400 hover:underline",children:["Open in Spotify",e.jsx(T,{size:14})]})]}):e.jsxs("div",{className:`flex items-center gap-3 ${y}`,children:[e.jsx("audio",{ref:a,src:m}),e.jsx("button",{onClick:x,className:"flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors","aria-label":j?"Pause preview":"Play preview",children:j?e.jsx(O,{size:20}):e.jsx(Y,{size:20})}),e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx(G,{size:16,className:"text-gray-500 dark:text-gray-400"}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:b,onChange:o,className:"flex-1 h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer"}),e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400 w-8",children:[Math.round(b*100),"%"]})]}),p&&e.jsx("a",{href:p,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-sm text-blue-600 dark:text-blue-400 hover:underline",title:"Open full track in Spotify",children:e.jsx(T,{size:14})}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.jsx("span",{className:"text-[10px]",children:"Powered by Spotify"})})]})}const ae=["C Major","C# Major","D Major","D# Major","E Major","F Major","F# Major","G Major","G# Major","A Major","A# Major","B Major"],se=["Intro","Verse","Pre-Chorus","Chorus","Bridge","Outro","Prechorus"];function ge({isOpen:m,onClose:p,onSave:y,onUpdate:j,song:t,title:b="Add New Song"}){const f=!!t,[a,x]=c.useState({title:"",artist:"",type:"",origin:"",year:new Date().getFullYear(),season:"Spring",sections:[]}),[o,n]=c.useState({}),[l,S]=c.useState(!1),[v,_]=c.useState(!1),{mapping:k}=re(t??null),[A,I]=c.useState(!1),w=c.useRef(null);c.useEffect(()=>{let r=!1;const s=t?.id||null;return m&&(!A||t&&s!==w.current||!t&&w.current!==null)?((async()=>{if(t&&m){_(!0);try{const g=await C.getBySongId(t.id);r||(x({title:t.title,artist:t.artist,type:t.type,origin:t.origin||"",year:t.year,season:t.season||"Spring",sections:g.length>0?g.map((u,h)=>({id:`section_${t.id}_${h}`,part:u.part,bpm:String(u.bpm),key:u.key})):[{id:`section_new_${Date.now()}`,part:"",bpm:"",key:""}]}),w.current=t.id)}catch(g){console.error("Error loading sections:",g),r||(x({title:t.title,artist:t.artist,type:t.type,origin:t.origin||"",year:t.year,season:t.season||"Spring",sections:[{id:`section_new_${Date.now()}`,part:"",bpm:"",key:""}]}),w.current=t.id)}finally{r||_(!1)}}else!t&&m&&(r||(x({title:"",artist:"",type:"",origin:"",year:new Date().getFullYear(),season:"Spring",sections:[{id:`section_new_${Date.now()}`,part:"",bpm:"",key:""}]}),w.current=null));r||(n({}),I(!0))})(),()=>{r=!0}):void 0},[t,m,A]),c.useEffect(()=>{m||(I(!1),w.current=null)},[m]);const $=c.useCallback(async()=>{const r={};if(a.title.trim()||(r.title="Title is required"),a.artist.trim()||(r.artist="Artist is required"),a.sections.filter(i=>{const d=parseFloat(i.bpm);return i.part.trim()!==""&&!isNaN(d)&&d>0&&i.key.trim()!==""}).length===0&&(r.sections="At least one valid section (PART, BPM, and Key) is required"),(a.year<1900||a.year>2030)&&(r.year="Year must be between 1900 and 2030"),n(r),!(Object.keys(r).length>0)){S(!0),n({});try{const i={title:a.title.trim(),artist:a.artist.trim(),type:a.type||"Anime",origin:a.origin.trim()||"Japan",year:a.year,season:a.season,notes:"",bpms:[],keys:[]};let d;if(f&&t){d={...t,...i};const u=await j?.(d);u&&(d=u),await C.deleteBySongId(d.id)}else d=await y(i);const g=a.sections.filter(u=>{const h=parseFloat(u.bpm);return u.part.trim()!==""&&!isNaN(h)&&h>0&&u.key.trim()!==""}).map((u,h)=>({sectionId:`${d.id}_section_${Date.now()}_${h}`,songId:d.id,part:u.part.trim(),bpm:parseFloat(u.bpm),key:u.key.trim(),sectionOrder:h+1}));g.length>0&&await C.bulkAdd(g);try{const{ExportService:u}=await L(async()=>{const{ExportService:M}=await import("./index-DrdfCScI.js").then(P=>P.e);return{ExportService:M}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{songService:h}=await L(async()=>{const{songService:M}=await import("./index-DrdfCScI.js").then(P=>P.d);return{songService:M}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),B=await h.getAll();await u.exportSongsToCSV(B,"updated"),console.log(`CSV files exported after song ${f?"edit":"creation"}`)}catch(u){console.warn("Failed to export CSV files after save:",u)}p()}catch(i){console.error("Error saving song:",i),n({general:"Failed to save song. Please try again."})}finally{S(!1)}}},[a,f,p,y,j,t]),N=c.useCallback((r,s,i)=>{x(d=>{const g=[...d.sections];return g[r]={...g[r],[s]:i},{...d,sections:g}}),o.sections&&n(d=>({...d,sections:""}))},[o.sections]),z=c.useCallback(()=>{x(r=>({...r,sections:[...r.sections,{id:`section_${Date.now()}_${Math.random()}`,part:"",bpm:"",key:""}]}))},[]),D=c.useCallback(r=>{x(s=>{if(s.sections.length>1){const i=s.sections.filter((d,g)=>g!==r);return{...s,sections:i}}return s})},[]),E=c.useCallback((r,s)=>{s==="up"&&r===0||x(i=>{if(s==="down"&&r===i.sections.length-1)return i;const d=[...i.sections],g=s==="up"?r-1:r+1;return[d[r],d[g]]=[d[g],d[r]],{...i,sections:d}})},[]),V=J(),F=c.useMemo(()=>m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-4 md:p-6 border-b dark:border-gray-700",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100",children:b}),e.jsx("button",{onClick:p,className:"p-2 min-w-[44px] min-h-[44px] flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-md transition-colors disabled:opacity-50",disabled:l,"aria-label":"Close",children:e.jsx(q,{size:20,className:"md:w-6 md:h-6"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[o.general&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3 flex items-center",children:[e.jsx(U,{size:16,className:"text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700 dark:text-red-300 text-sm",children:o.general})]}),k&&e.jsx("div",{className:"border-t border-b border-gray-200 dark:border-gray-700 py-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6 items-start md:items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(K,{imageUrl:k.imageUrlLarge,alt:`${t?.title||a.title} by ${t?.artist||a.artist}`,size:"large",lazy:!1})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Preview"}),e.jsx(te,{previewUrl:k.previewUrl,spotifyUrl:k.spotifyExternalUrl,trackName:t?.title||a.title}),k.spotifyExternalUrl&&e.jsx("div",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400",children:e.jsx("span",{children:"Powered by Spotify"})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Title *"}),e.jsx("input",{type:"text",value:a.title,onChange:r=>x(s=>({...s,title:r.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 ${o.title?"border-red-300":"border-gray-300"}`,placeholder:"Enter song title",disabled:l}),o.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:o.title})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Artist *"}),e.jsx("input",{type:"text",value:a.artist,onChange:r=>x(s=>({...s,artist:r.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 ${o.artist?"border-red-300":"border-gray-300"}`,placeholder:"Enter artist name",disabled:l}),o.artist&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:o.artist})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Song Sections *"}),e.jsxs("button",{type:"button",onClick:z,disabled:l,className:"flex items-center space-x-1 text-sm text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300",children:[e.jsx(W,{size:16}),e.jsx("span",{children:"Add Section"})]})]}),v?e.jsx("div",{className:"text-center py-4 text-gray-500 dark:text-gray-400",children:"Loading sections..."}):e.jsx("div",{className:"space-y-3",children:a.sections.map((r,s)=>e.jsxs("div",{className:"border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:["Section ",s+1]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>E(s,"up"),disabled:l||s===0,className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-50","aria-label":"Move up",children:e.jsx(H,{size:16})}),e.jsx("button",{type:"button",onClick:()=>E(s,"down"),disabled:l||s===a.sections.length-1,className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-50","aria-label":"Move down",children:e.jsx(X,{size:16})}),a.sections.length>1&&e.jsx("button",{type:"button",onClick:()=>D(s),disabled:l,className:"p-1 text-red-600 hover:text-red-800 dark:hover:text-red-400","aria-label":"Remove section",children:e.jsx(Q,{size:16})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:"PART *"}),e.jsxs("select",{value:r.part,onChange:i=>N(s,"part",i.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-800 dark:text-gray-300",disabled:l,children:[e.jsx("option",{value:"",children:"Select PART"}),se.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:"BPM *"}),e.jsx("input",{type:"number",value:r.bpm,onChange:i=>N(s,"bpm",i.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-800 dark:text-gray-300",placeholder:"Enter BPM",disabled:l,min:"1",max:"300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1",children:"Key *"}),e.jsxs("select",{value:r.key,onChange:i=>N(s,"key",i.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-800 dark:text-gray-300",disabled:l,children:[e.jsx("option",{value:"",children:"Select key"}),ae.map(i=>e.jsx("option",{value:i,children:i},i))]})]})]})]},r.id||`section_${s}`))}),o.sections&&e.jsx("p",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:o.sections})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Type"}),e.jsxs("select",{value:a.type,onChange:r=>x(s=>({...s,type:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",disabled:l,children:[e.jsx("option",{value:"",children:"Select type"}),e.jsx("option",{value:"Anime",children:"Anime"}),e.jsx("option",{value:"Game",children:"Game"}),e.jsx("option",{value:"J-Pop",children:"J-Pop"}),e.jsx("option",{value:"K-Pop",children:"K-Pop"}),e.jsx("option",{value:"Electronic",children:"Electronic"}),e.jsx("option",{value:"Rock",children:"Rock"}),e.jsx("option",{value:"Pop",children:"Pop"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Origin"}),e.jsx("input",{type:"text",value:a.origin,onChange:r=>x(s=>({...s,origin:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",placeholder:"e.g., Japan, USA",disabled:l})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Year"}),e.jsx("input",{type:"number",value:a.year,onChange:r=>x(s=>({...s,year:parseInt(r.target.value)||0})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 ${o.year?"border-red-300":"border-gray-300"}`,min:"1900",max:"2030",disabled:l}),o.year&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:o.year})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Season"}),e.jsxs("select",{value:a.season,onChange:r=>x(s=>({...s,season:r.target.value})),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300",disabled:l,children:[e.jsx("option",{value:"Spring",children:"Spring"}),e.jsx("option",{value:"Summer",children:"Summer"}),e.jsx("option",{value:"Fall",children:"Fall"}),e.jsx("option",{value:"Winter",children:"Winter"})]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 sm:space-x-3 p-4 md:p-6 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:[e.jsx("button",{onClick:p,className:"btn-secondary w-full sm:w-auto min-h-[44px]",disabled:l,children:"Cancel"}),e.jsx("button",{onClick:$,className:"btn-primary w-full sm:w-auto min-h-[44px]",disabled:l||v,children:l?"Saving...":f?"Update Song":"Save Song"})]})]}):null,[m,b,a,o,l,f,v,k,t,$,p,N,z,D,E]);return m?V?e.jsx(Z,{open:m,onOpenChange:p,children:e.jsx(ee,{side:"bottom",className:"h-[90vh] p-0 flex flex-col",showDragHandle:!0,children:e.jsx("div",{className:"flex-1 overflow-y-auto bg-white dark:bg-gray-800",children:F})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:F})}):null}export{ge as SongModal};
